steps:
  - task: NodeTool@0
    displayName: 'Use Node 12.x'
    inputs:
      versionSpec: 12.x

  - task: CacheBeta@1
    displayName: Cache NPM packages
    inputs:
      key: npm | $(Agent.OS) | package-lock.json
      path: $(npm_config_cache)
      restoreKeys: npm | $(Agent.OS) | package-lock.json

  - task: CacheBeta@1
    displayName: Cache Cypress binary
    inputs:
      key: cypress | $(Agent.OS) | package-lock.json
      path: $(cypress_cache_folder)
      restoreKeys: cypress | $(Agent.OS) | package-lock.json
    
  # - task: Cache@2
  #   displayName: 'Cache npm'
  #   inputs:
  #     key: 'npm | "$(Agent.OS)" | package-lock.json'
  #     restoreKeys: |
  #       npm | "$(Agent.OS)"
  #       npm
  #     path: $(npm_config_cache)

  - script: npm ci
    displayName: 'Install NPM dependencies'

  - script: npm run cy:verify
    displayName: 'Cypress verify'

 

  - bash: |
      eval "npx print-env AGENT"
      eval "npx print-env BUILD"
      eval "npx print-env SYSTEM"
      eval "npm run start:ci:windows & npx cypress run --group ${{ parameters.browserType }} --browser ${{ parameters.browserType }} --record --parallel  --ci-build-id $BUILDID"
    displayName: 'Run the cypress tests'
    env:
      TERM: xterm
      BUILDID: $(Build.BuildId)
  
  - task: PublishTestResults@2
    displayName: 'Publish the test reports'
    inputs:
      testResultsFiles: '**/reports/junit.*.xml'
    condition: succeededOrFailed()
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish screenshots when there were issues'
    inputs:
      pathtoPublish: 'cypress/screenshots'
      artifactName: screenshots-${{ parameters.browserType }}
    condition: failed()
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish videos'
    inputs:
      pathtoPublish: 'cypress/videos'
      artifactName: videos-${{ parameters.browserType }}
    condition: succeededOrFailed()
    continueOnError: true